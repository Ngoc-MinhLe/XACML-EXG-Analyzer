<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XACML EXG Analyzer - Research Pro v5.6</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        
        /* Graph Viewport */
        .graph-viewport { 
            @apply flex-1 overflow-hidden relative bg-slate-50/50 cursor-grab active:cursor-grabbing;
            border-radius: 8px;
        }
        #graphOutput, #modalGraph { 
            transform-origin: 0 0;
            transition: transform 0.1s ease-out;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* PRECISION FIX: Mermaid Node Label Scaling for Perfect Fit */
        foreignObject { 
            overflow: visible !important; 
        }
        .nodeLabel {
            font-size: 16px !important; /* Kích thước font tối ưu */
            line-height: 1.2 !important;
            width: max-content; /* Ép khung theo chiều rộng chữ */
            max-width: 260px; 
            white-space: normal !important;
            word-wrap: break-word !important;
            text-align: center;
            padding: 0 !important; /* Reset padding để custom bên trong */
            overflow: visible !important;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #1e293b;
        }
        .node-content {
            padding: 12px 16px;
            width: 100%;
        }
        .nodeLabel b {
            font-size: 17px !important;
            display: block;
            margin-bottom: 2px;
            color: #0f172a;
            font-weight: 800;
        }
        .nodeLabel small {
            font-size: 12px !important;
            opacity: 0.6;
            font-weight: 700;
            text-transform: uppercase;
            display: block;
            letter-spacing: 0.05em;
        }
        .status-tag {
            width: 100%;
            margin-top: 4px;
            font-weight: 800;
            padding: 4px 0;
            font-size: 14px;
            text-transform: uppercase;
            border-bottom-left-radius: 6px;
            border-bottom-right-radius: 6px;
        }
        
        /* Decision Colors for Status Tags */
        .tag-permit { background-color: #10b981; color: white; }
        .tag-deny { background-color: #ef4444; color: white; }
        .tag-na { background-color: #bae6fd; color: #0369a1; }

        .glass-panel { @apply bg-white/95 backdrop-blur-md border border-slate-200 rounded-xl shadow-sm; }
        .attr-input { @apply w-full bg-slate-50 border border-slate-200 rounded px-2 py-1.5 text-[11px] outline-none focus:border-indigo-400 font-mono transition-all; }
        .attr-label { @apply text-[9px] font-bold text-slate-400 uppercase mb-1 block; }

        /* Modal Styles */
        .modal { @apply fixed inset-0 z-[100] hidden flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4; }
        .modal-content { @apply bg-white w-full h-full rounded-2xl shadow-2xl flex flex-col overflow-hidden; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }

        svg { max-width: none !important; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-slate-900 text-white px-6 py-3 flex justify-between items-center shadow-lg shrink-0 z-50">
        <div class="flex items-center gap-3">
            <div class="p-2 bg-gradient-to-br from-indigo-500 to-emerald-500 rounded-lg shadow-lg">
                <i class="fa-solid fa-chart-network text-xl"></i>
            </div>
            <div>
                <h1 class="font-bold text-base tracking-tight leading-none mb-1">XACML EXG Analyzer <span class="text-[9px] bg-indigo-600 px-1.5 py-0.5 rounded ml-1 uppercase">v5.6 PRECISION</span></h1>
                <p class="text-[9px] text-slate-400 uppercase tracking-widest font-semibold italic">Decision Visualization Framework</p>
            </div>
        </div>
        <div class="flex gap-2">
            <label class="bg-slate-800 hover:bg-slate-700 px-3 py-1.5 rounded-lg text-xs font-medium cursor-pointer transition-all border border-slate-700 flex items-center gap-2">
                <i class="fa-solid fa-folder-open"></i> Load Dataset
                <input type="file" id="fileInput" accept=".xml" class="hidden" onchange="handleFile(this)">
            </label>
            <button onclick="runAnalysis()" class="bg-indigo-600 hover:bg-indigo-500 px-4 py-1.5 rounded-lg text-xs font-bold shadow-lg transition-all flex items-center gap-2">
                <i class="fa-solid fa-play"></i> Run Simulation
            </button>
            <button onclick="exportResults()" class="bg-emerald-600 hover:bg-emerald-500 px-4 py-1.5 rounded-lg text-xs font-bold shadow-lg transition-all flex items-center gap-2">
                <i class="fa-solid fa-download"></i> Save Data
            </button>
        </div>
    </header>

    <!-- Main -->
    <main class="flex-1 overflow-hidden p-3 gap-3 grid grid-cols-12">
        
        <!-- Left: Attributes & Tree -->
        <div class="col-span-3 flex flex-col gap-3 overflow-hidden">
            <div class="glass-panel p-3 shrink-0">
                <h3 class="font-bold text-slate-700 text-[10px] mb-3 uppercase tracking-widest flex justify-between items-center">
                    <span><i class="fa-solid fa-sliders mr-2 text-indigo-500"></i> Request Attributes</span>
                    <button onclick="resetAttrs()" class="text-[8px] hover:text-indigo-600">RESET</button>
                </h3>
                <div class="grid grid-cols-2 gap-2">
                    <div><label class="attr-label">Role</label><input type="text" id="attr_role" value="doctor" class="attr-input"></div>
                    <div><label class="attr-label">Zone</label><input type="text" id="attr_zone" value="medical" class="attr-input"></div>
                    <div><label class="attr-label">Action</label><input type="text" id="attr_action" value="read" class="attr-input"></div>
                    <div><label class="attr-label">Origin</label><input type="text" id="attr_origin" value="internal" class="attr-input"></div>
                    <div><label class="attr-label">Dept</label><input type="text" id="attr_dept" value="medical" class="attr-input"></div>
                    <div><label class="attr-label">Sensitivity</label><input type="text" id="attr_sensitivity" value="public" class="attr-input"></div>
                </div>
            </div>

            <div class="glass-panel flex-1 flex flex-col overflow-hidden">
                <div class="px-3 py-2 border-b border-slate-100 font-bold text-slate-700 flex items-center justify-between">
                    <span class="text-[10px] uppercase"><i class="fa-solid fa-sitemap mr-2"></i> Structure</span>
                    <span id="nodeCount" class="text-[9px] bg-slate-100 px-1.5 py-0.5 rounded text-slate-500">0 Nodes</span>
                </div>
                <div id="policyTree" class="p-3 overflow-y-auto flex-1 text-[10px] text-slate-500 font-mono leading-relaxed">
                    <p class="italic text-center mt-10">Upload XACML to analyze structure...</p>
                </div>
            </div>
        </div>

        <!-- Center: EXG Viewer -->
        <div class="col-span-6 flex flex-col gap-3 overflow-hidden">
            <div class="glass-panel flex-1 flex flex-col overflow-hidden relative">
                <div class="px-4 py-2 border-b border-slate-100 font-bold text-slate-700 flex justify-between items-center bg-white shrink-0 z-10">
                    <span class="text-[10px] uppercase flex items-center gap-2">
                        <i class="fa-solid fa-project-diagram text-indigo-500"></i> 
                        Evaluation Explanation Graph
                    </span>
                    <div class="flex items-center gap-3">
                        <div class="flex gap-2">
                            <button onclick="zoom(1.1)" class="w-6 h-6 flex items-center justify-center bg-slate-100 rounded hover:bg-slate-200 transition-all"><i class="fa-solid fa-plus text-[10px]"></i></button>
                            <button onclick="zoom(0.9)" class="w-6 h-6 flex items-center justify-center bg-slate-100 rounded hover:bg-slate-200 transition-all"><i class="fa-solid fa-minus text-[10px]"></i></button>
                            <button onclick="resetZoom()" class="w-6 h-6 flex items-center justify-center bg-slate-100 rounded hover:bg-slate-200 transition-all"><i class="fa-solid fa-compress text-[10px]"></i></button>
                        </div>
                        <button onclick="toggleModal(true)" class="text-indigo-600 text-[10px] font-bold hover:underline transition-all hover:scale-105 uppercase"><i class="fa-solid fa-maximize mr-1"></i> Mode: Pro View</button>
                    </div>
                </div>
                
                <div class="graph-viewport" id="viewport" onmousedown="startDrag(event)" onwheel="handleWheel(event)">
                    <div id="graphOutput" class="mermaid transition-transform duration-75">
                        graph TD
                        A[Waiting for analysis...]
                    </div>
                </div>

                <!-- Legend -->
                <div class="absolute bottom-4 left-4 flex gap-3 text-[9px] font-bold bg-white/80 p-2 rounded-lg border border-slate-200 shadow-sm backdrop-blur pointer-events-none">
                    <span class="flex items-center gap-1"><span class="w-2 h-2 rounded bg-emerald-500 shadow-sm"></span> PERMIT</span>
                    <span class="flex items-center gap-1"><span class="w-2 h-2 rounded bg-rose-500 shadow-sm"></span> DENY</span>
                    <span class="flex items-center gap-1"><span class="w-2 h-2 rounded border border-sky-300 bg-sky-50 shadow-sm"></span> NA</span>
                </div>
            </div>
        </div>

        <!-- Right: Metrics -->
        <div class="col-span-3 flex flex-col gap-3 overflow-hidden">
            <div class="glass-panel flex-1 flex flex-col overflow-hidden">
                <div class="px-3 py-2 border-b border-slate-100 font-bold text-slate-700 text-[10px] uppercase">
                    <i class="fa-solid fa-chart-line mr-2 text-indigo-500"></i> Research Metrics
                </div>
                <div id="metricsArea" class="p-4 overflow-y-auto flex-1 flex flex-col gap-4">
                    <div class="text-center py-20 opacity-20"><i class="fa-solid fa-microscope text-6xl"></i></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Fullscreen Modal -->
    <div id="graphModal" class="modal">
        <div class="modal-content">
            <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <h2 class="font-bold text-slate-800 text-sm uppercase italic tracking-wider">Detailed EXG Analysis View - High Precision Scale</h2>
                <div class="flex gap-4">
                    <button onclick="fitGraph()" class="px-4 py-1 bg-white border border-slate-200 rounded text-xs font-bold text-indigo-600 hover:bg-indigo-50 transition-all shadow-sm"><i class="fa-solid fa-expand mr-1"></i> AUTO-FIT</button>
                    <button onclick="toggleModal(false)" class="w-8 h-8 flex items-center justify-center bg-white border border-slate-200 rounded-full text-slate-400 hover:text-rose-500 transition-all shadow-sm"><i class="fa-solid fa-xmark"></i></button>
                </div>
            </div>
            <div class="flex-1 overflow-hidden relative bg-slate-50/80" id="modalViewport" onmousedown="startModalDrag(event)" onwheel="handleModalWheel(event)">
                <div id="modalGraph" class="mermaid transition-transform duration-75 origin-top-left"></div>
            </div>
            <div class="p-2 bg-white border-t border-slate-100 flex justify-center gap-6 text-[11px] text-slate-500 font-medium">
                <span><i class="fa-solid fa-mouse mr-1 text-slate-300"></i> <b>Wheel</b> to Zoom</span>
                <span><i class="fa-solid fa-arrows-up-down-left-right mr-1 text-slate-300"></i> <b>Drag</b> to Move</span>
                <span class="text-indigo-600 font-bold"><i class="fa-solid fa-check-circle mr-1"></i> Precision Mode v5.6 Active</span>
            </div>
        </div>
    </div>

    <script>
        let rawPolicyData = null;
        let lastMermaidDef = "";

        // --- ZOOM & PAN ENGINE ---
        let scale = 0.8, posX = 100, posY = 50, panning = false;
        let mScale = 0.6, mPosX = 100, mPosY = 50, mPanning = false;

        function updateTransform() {
            const el = document.getElementById('graphOutput');
            el.style.transform = `translate(${posX}px, ${posY}px) scale(${scale})`;
        }

        function zoom(delta) { scale *= delta; updateTransform(); }
        function resetZoom() { scale = 0.7; posX = 100; posY = 50; updateTransform(); }

        function fitGraph() {
            const el = document.getElementById('modalGraph');
            const svg = el.querySelector('svg');
            if(!svg) return;
            const container = document.getElementById('modalViewport');
            const scaleX = (container.clientWidth - 80) / svg.getBBox().width;
            const scaleY = (container.clientHeight - 80) / svg.getBBox().height;
            mScale = Math.min(scaleX, scaleY, 0.95); 
            mPosX = 40; mPosY = 40;
            updateModalTransform();
        }

        function handleWheel(e) { e.preventDefault(); zoom(e.deltaY > 0 ? 0.9 : 1.1); }
        
        function startDrag(e) {
            if(e.target.closest('button')) return;
            panning = true;
            let startX = e.clientX - posX;
            let startY = e.clientY - posY;
            const onMove = (moveEvent) => {
                if(!panning) return;
                posX = moveEvent.clientX - startX;
                posY = moveEvent.clientY - startY;
                updateTransform();
            };
            const onUp = () => { panning = false; window.removeEventListener('mousemove', onMove); window.removeEventListener('mouseup', onUp); };
            window.addEventListener('mousemove', onMove);
            window.addEventListener('mouseup', onUp);
        }

        function updateModalTransform() {
            const el = document.getElementById('modalGraph');
            el.style.transform = `translate(${mPosX}px, ${mPosY}px) scale(${mScale})`;
        }
        function handleModalWheel(e) { e.preventDefault(); mScale *= e.deltaY > 0 ? 0.9 : 1.1; updateModalTransform(); }
        function startModalDrag(e) {
            mPanning = true;
            let startX = e.clientX - mPosX;
            let startY = e.clientY - mPosY;
            const onMove = (m) => { if(!mPanning) return; mPosX = m.clientX - startX; mPosY = m.clientY - startY; updateModalTransform(); };
            const onUp = () => { mPanning = false; window.removeEventListener('mousemove', onMove); window.removeEventListener('mouseup', onUp); };
            window.addEventListener('mousemove', onMove);
            window.addEventListener('mouseup', onUp);
        }

        function toggleModal(show) {
            const modal = document.getElementById('graphModal');
            if(show) {
                modal.classList.remove('hidden');
                const out = document.getElementById('modalGraph');
                out.innerHTML = lastMermaidDef;
                out.removeAttribute('data-processed');
                mermaid.init(undefined, out).then(() => { fitGraph(); });
            } else modal.classList.add('hidden');
        }

        // --- CORE LOGIC ---
        function handleFile(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const parser = new DOMParser();
                rawPolicyData = parser.parseFromString(e.target.result, "text/xml");
                renderTree();
            };
            reader.readAsText(file);
        }

        function renderTree() {
            const tree = document.getElementById('policyTree');
            const badge = document.getElementById('nodeCount');
            tree.innerHTML = "";
            let count = 0;
            function walk(node, depth = 0) {
                if (node.nodeType !== 1) return "";
                const tag = node.tagName;
                const id = node.getAttribute('PolicySetId') || node.getAttribute('PolicyId') || node.getAttribute('RuleId');
                if (!id && !["Target", "Condition"].includes(tag)) return "";
                count++;
                let html = `<div style="padding-left: ${depth * 6}px" class="border-l border-slate-100 ml-1 py-0.5 whitespace-nowrap">
                    <span class="text-slate-300">└</span> <span class="text-slate-700 font-bold">${tag}</span> <span class="text-indigo-500">${id || ''}</span>
                </div>`;
                Array.from(node.children).forEach(c => html += walk(c, depth + 1));
                return html;
            }
            tree.innerHTML = walk(rawPolicyData.documentElement);
            badge.innerText = `${count} Items`;
        }

        function getAttrs() {
            return {
                role: document.getElementById('attr_role').value,
                zone: document.getElementById('attr_zone').value,
                action: document.getElementById('attr_action').value,
                origin: document.getElementById('attr_origin').value,
                dept: document.getElementById('attr_dept').value,
                sensitivity: document.getElementById('attr_sensitivity').value
            };
        }

        function runAnalysis() {
            if(!rawPolicyData) return alert("Please load XACML file.");
            const start = performance.now();
            const attrs = getAttrs();
            let mermaidDef = "graph TD\n";

            function evalNode(node) {
                const tag = node.tagName;
                const rawId = (node.getAttribute('PolicySetId') || node.getAttribute('PolicyId') || node.getAttribute('RuleId') || Math.random().toString(36).substr(2,4));
                const id = rawId.replace(/\W/g, '_');
                const alg = node.getAttribute('PolicyCombiningAlgId') || node.getAttribute('RuleCombiningAlgId') || "permit-overrides";

                let decision = "NotApplicable";
                
                const target = node.querySelector(':scope > Target');
                let targetMatch = true;
                if(target) {
                    targetMatch = false;
                    const matches = target.querySelectorAll('Match');
                    for(let m of matches) {
                        if(attrs[m.getAttribute('AttributeId')] === m.getAttribute('Value')) { targetMatch = true; break; }
                    }
                }

                if(!targetMatch) {
                    mermaidDef += `${id}["<div class='nodeLabel'><div class='node-content'><small>${tag}</small><b>${rawId}</b></div><div class='status-tag tag-na'>NA</div></div>"]:::na\n`;
                    return { id, decision: "NotApplicable" };
                }

                let childResults = [];
                Array.from(node.children).forEach(c => {
                    if(["PolicySet", "Policy", "Rule"].includes(c.tagName)) {
                        const r = evalNode(c);
                        childResults.push(r);
                        mermaidDef += `${id} --> ${r.id}\n`;
                    }
                });

                if(tag === "Rule") {
                    const effect = node.getAttribute('Effect');
                    const condition = node.querySelector('Condition AttributeValue');
                    let condOk = true;
                    if(condition) condOk = (Object.values(attrs).includes(condition.textContent.trim()));
                    decision = condOk ? effect : "NotApplicable";
                } else if(childResults.length > 0) {
                    const decs = childResults.map(c => c.decision);
                    if(alg.includes("deny-overrides")) {
                        decision = decs.includes("Deny") ? "Deny" : (decs.includes("Permit") ? "Permit" : "NotApplicable");
                    } else {
                        decision = decs.includes("Permit") ? "Permit" : (decs.includes("Deny") ? "Deny" : "NotApplicable");
                    }
                }

                let css = tag.toLowerCase();
                let tagClass = "tag-na";
                if(decision === "Permit") { css = "permit_node"; tagClass = "tag-permit"; }
                if(decision === "Deny") { css = "deny_node"; tagClass = "tag-deny"; }
                
                mermaidDef += `${id}["<div class='nodeLabel'><div class='node-content'><small>${tag}</small><b>${rawId}</b></div><div class='status-tag ${tagClass}'>${decision}</div></div>"]:::${css}\n`;
                return { id, decision };
            }

            const res = evalNode(rawPolicyData.documentElement);
            const time = (performance.now() - start).toFixed(2);

            mermaidDef += `classDef policyset fill:#f1f5f9,stroke:#3b82f6,color:#1e40af,stroke-width:1.5px;\n`;
            mermaidDef += `classDef policy fill:#f8fafc,stroke:#8b5cf6,color:#4c1d95,stroke-width:1.5px;\n`;
            mermaidDef += `classDef rule fill:#fff,stroke:#e2e8f0,stroke-width:1.5px;\n`;
            mermaidDef += `classDef na fill:#f0f9ff,stroke:#7dd3fc,color:#0369a1,stroke-dasharray: 4 4;\n`; 
            mermaidDef += `classDef permit_node fill:#d1fae5,stroke:#10b981,color:#065f46,stroke-width:4px;\n`;
            mermaidDef += `classDef deny_node fill:#fee2e2,stroke:#ef4444,color:#7f1d1d,stroke-width:4px;\n`;

            lastMermaidDef = mermaidDef;
            const out = document.getElementById('graphOutput');
            out.innerHTML = mermaidDef;
            out.removeAttribute('data-processed');
            mermaid.init(undefined, out);
            
            updateMetrics(res.decision, time);
            resetZoom();
        }

        function updateMetrics(dec, time) {
            const area = document.getElementById('metricsArea');
            const color = dec === 'Permit' ? 'text-emerald-600' : (dec === 'Deny' ? 'text-rose-600' : 'text-slate-400');
            const bg = dec === 'Permit' ? 'bg-emerald-50' : (dec === 'Deny' ? 'bg-rose-50' : 'bg-slate-50');

            area.innerHTML = `
                <div class="${bg} p-4 rounded-xl border-2 border-current animate-fade-in shadow-lg">
                    <p class="text-[9px] font-bold opacity-60 uppercase mb-1">Decision Analysis</p>
                    <p class="text-3xl font-black ${color} tracking-tighter">${dec}</p>
                    <p class="text-[10px] text-slate-400 mt-2 italic">Latency: ${time} ms</p>
                </div>

                <div class="grid grid-cols-2 gap-2">
                    <div class="p-3 bg-white border border-slate-100 rounded-lg text-center shadow-sm">
                        <p class="text-[9px] font-bold text-slate-400 uppercase">Status</p>
                        <p class="text-sm font-bold text-emerald-500">Verified</p>
                    </div>
                    <div class="p-3 bg-white border border-slate-100 rounded-lg text-center shadow-sm">
                        <p class="text-[9px] font-bold text-slate-400 uppercase">Nodes</p>
                        <p class="text-sm font-bold text-blue-500">${document.getElementById('nodeCount').innerText.split(' ')[0]}</p>
                    </div>
                </div>

                <div class="bg-slate-900 p-4 rounded-xl font-mono text-[10px] text-emerald-400 leading-relaxed overflow-x-auto shadow-xl">
                    <p class="text-slate-500 mb-2">// Statistical Research Trace</p>
                    <p>Engine_Version: "v5.6"</p>
                    <p>Scaling_Mode: "Precision-Tight"</p>
                    <p>Compliance: XACML 3.0</p>
                </div>
            `;
        }

        function resetAttrs() { document.querySelectorAll('.attr-input').forEach(i => i.value = ""); }

        mermaid.initialize({ 
            startOnLoad: true, 
            theme: 'neutral', 
            securityLevel: 'loose', 
            fontSize: 16, 
            flowchart: { 
                useMaxWidth: false, 
                htmlLabels: true, 
                curve: 'basis',
                nodeSpacing: 100, 
                rankSpacing: 100  
            } 
        });
    </script>
</body>
</html>